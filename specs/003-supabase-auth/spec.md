# Спецификация функции: Авторизация и Профили пользователей (Supabase)

**Ветка функции**: `003-supabase-auth`
**Дата создания**: 2026-01-11
**Статус**: Черновик
**Входные данные**: Описание пользователя: "Я создал проект snapperfect в supabase и хотел бы чтобы пользователи могли логиниться и заходить в свой профиль, чтобы были учетки free и pro, чтобы у каждого пользователя был свой аккаунт с данными и прочее все что необходимо для этого проекта"

## Пользовательские сценарии и Тестирование

### Пользовательский сценарий 1 - Регистрация и Вход (Приоритет: P1)

Пользователь (новый или существующий) хочет войти в систему, чтобы получить доступ к функционалу приложения.

**Почему этот приоритет**: Это фундаментальная функция, без которой невозможна идентификация пользователя и работа с личными данными.

**Независимый тест**: Можно полностью протестировать, попытавшись зарегистрироваться с новым email и войти с существующим.

**Сценарии приемки**:

1. **Дано** незарегистрированный пользователь, **Когда** он вводит email/пароль и нажимает "Регистрация", **Тогда** создается новый аккаунт в Supabase и пользователь перенаправляется в профиль.
2. **Дано** зарегистрированный пользователь, **Когда** он вводит верные учетные данные, **Тогда** происходит успешный вход и редирект на главную/профиль.
3. **Дано** любой пользователь, **Когда** он вводит неверный пароль, **Тогда** система показывает ошибку и не пускает в аккаунт.

---

### Пользовательский сценарий 2 - Просмотр и редактирование профиля (Приоритет: P1)

Пользователь хочет видеть свои данные и статус подписки, чтобы управлять своим аккаунтом.

**Почему этот приоритет**: Необходим для персонализации и отображения статуса Free/Pro.

**Независимый тест**: Зайти под пользователем и проверить отображение данных профиля.

**Сценарии приемки**:

1. **Дано** залогиненный пользователь, **Когда** он переходит на страницу профиля, **Тогда** он видит свой email, имя и текущий статус подписки (Free/Pro).
2. **Дано** пользователь, **Когда** он меняет свое имя в профиле, **Тогда** изменения сохраняются в базе данных и отображаются после перезагрузки.

---

### Пользовательский сценарий 3 - Разграничение доступа к данным (Приоритет: P1)

Пользователь должен иметь доступ ТОЛЬКО к своим данным.

**Почему этот приоритет**: Критически важно для безопасности и конфиденциальности.

**Независимый тест**: Попытаться запросить данные другого пользователя через API/клиент.

**Сценарии приемки**:

1. **Дано** пользователь А и пользователь Б, **Когда** пользователь А запрашивает профиль пользователя Б, **Тогда** система возвращает ошибку или пустой результат (благодаря RLS).

---

### Граничные случаи (Edge Cases)

- Что происходит, если пользователь пытается зарегистрироваться на уже занятый email? (Ожидается ошибка "Пользователь уже существует").
- Как система обрабатывает сбой сети при обновлении профиля? (Сообщение об ошибке, данные не теряются).
- Что видит пользователь, если его сессия истекла? (Редирект на страницу входа).

## Требования

### Функциональные требования

- **FR-001**: Система ДОЛЖНА использовать Supabase Auth для регистрации и аутентификации (Email/Password).
- **FR-002**: Система ДОЛЖНА автоматически создавать запись в таблице `profiles` при регистрации нового пользователя (через Database Trigger).
- **FR-003**: Система ДОЛЖНА хранить статус подписки (`tier`: 'free' | 'pro') в профиле пользователя. По умолчанию 'free'.
- **FR-004**: Пользователи ДОЛЖНЫ иметь возможность просматривать и редактировать своё имя и аватар.
- **FR-005**: Система ДОЛЖНА обеспечивать безопасность данных (RLS), позволяя пользователям читать/изменять только свои собственные записи в `profiles`.
- **FR-006**: Для целей MVP получение статуса Pro реализуется через кнопку-заглушку в интерфейсе ("Стать Pro"), которая переключает статус пользователя без реальной оплаты.
- **FR-007**: Интерфейс ДОЛЖЕН отображать элементы, доступные только для Pro, соответствующим образом (скрывать или блокировать для Free).

### Ключевые сущности

- **Users (auth.users)**: Стандартная таблица Supabase для аутентификации.
- **Profiles (public.profiles)**: Расширенная информация о пользователе.
    - `id` (uuid, reference to auth.users)
    - `email` (text)
    - `full_name` (text)
    - `avatar_url` (text)
    - `tier` (enum: 'free', 'pro')
    - `created_at` (timestamp)

## Критерии успеха

### Измеримые результаты

- **SC-001**: Пользователь может успешно зарегистрироваться и войти в систему менее чем за 1 минуту.
- **SC-002**: 100% запросов к чужим профилям блокируются политиками RLS.
- **SC-003**: Статус подписки (Free/Pro) корректно ограничивает или предоставляет доступ к функциям (проверяется тестом).
