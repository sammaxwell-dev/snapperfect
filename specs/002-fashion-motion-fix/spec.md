# Feature Specification: Исправление Fashion Motion Video Generation

**Feature Branch**: `002-fashion-motion-fix`  
**Created**: 2026-01-11  
**Status**: Draft  
**Input**: Текущее решение для fashion motions не работает - видео не генерируется либо генерируется в формате, который не воспроизводится

## Контекст проблемы

Текущая реализация в `app/api/fashion-motion/route.ts` использует неправильный метод получения сгенерированного видео. Согласно официальной документации Google Veo 3.1 API, для скачивания видео необходимо использовать метод `ai.files.download()`, а текущая реализация пытается:
1. Напрямую читать `videoBytes` из ответа
2. Загружать по `uri`
3. Скачивать через endpoint `/files/:name:download`

Ни один из этих методов не является официальным и может не работать корректно.

## User Scenarios & Testing

### User Story 1 - Генерация видео из фото одежды (Priority: P1)

Пользователь загружает фотографию модели в одежде и получает видео, где модель демонстрирует эту одежду с разных ракурсов.

**Why this priority**: Это основная и единственная функция fashion-motion. Без неё функционал полностью неработоспособен.

**Independent Test**: Загрузить фото модели в одежде → дождаться генерации видео → видео воспроизводится в стандартном HTML5 video player.

**Acceptance Scenarios**:

1. **Given** пользователь находится на странице Fashion Motion, **When** он загружает JPEG/PNG изображение модели в одежде и нажимает Generate, **Then** через 1-5 минут видео генерируется и отображается в плеере
2. **Given** видео сгенерировано, **When** пользователь нажимает кнопку воспроизведения, **Then** видео корректно воспроизводится со звуком или без
3. **Given** видео сгенерировано, **When** пользователь нажимает Download, **Then** файл скачивается в формате MP4 и воспроизводится в любом видеоплеере

---

### User Story 2 - Отображение прогресса генерации (Priority: P2)

Пользователь видит актуальный статус генерации видео, чтобы понимать сколько ждать.

**Why this priority**: Улучшает UX, но не является критичным для работы основной функции.

**Independent Test**: Начать генерацию → видеть обновляющийся статус → видеть индикатор завершения

**Acceptance Scenarios**:

1. **Given** генерация запущена, **When** процесс выполняется, **Then** отображается индикатор прогресса с примерным временем ожидания
2. **Given** генерация завершена, **When** видео готово, **Then** индикатор показывает 100% и видео автоматически появляется в плеере

---

### Edge Cases

- Что происходит при таймауте генерации (>5 минут)? → Показать понятное сообщение об ошибке с предложением повторить
- Как обрабатывается ошибка API quota exceeded? → Показать сообщение о превышении лимита
- Что если изображение не содержит человека/одежды? → Показать сообщение о safety filters с рекомендацией использовать другое фото

## Requirements

### Functional Requirements

- **FR-001**: API endpoint ДОЛЖЕН использовать официальный метод `ai.files.download()` для получения сгенерированного видео
- **FR-002**: Система ДОЛЖНА возвращать видео в формате MP4, совместимом с HTML5 video tag
- **FR-003**: Система ДОЛЖНА корректно обрабатывать polling операции с разумными интервалами (10 секунд)
- **FR-004**: Система ДОЛЖНА иметь таймаут генерации не более 5 минут
- **FR-005**: Клиент ДОЛЖЕН отображать прогресс генерации в UI
- **FR-006**: Сгенерированное видео ДОЛЖНО воспроизводиться в любом современном браузере (Chrome, Firefox, Safari)

### Key Entities

- **Video Operation**: Асинхронная операция генерации видео (name, done, response)
- **Generated Video**: Результат генерации (video object содержащий данные для скачивания)
- **Video Blob**: Бинарные данные видео для отображения/скачивания

## Success Criteria

### Measurable Outcomes

- **SC-001**: Сгенерированное видео воспроизводится в браузере в 100% случаев успешной генерации
- **SC-002**: Время от загрузки изображения до получения видео не превышает 5 минут при нормальных условиях
- **SC-003**: Скачанный MP4 файл воспроизводится в VLC, QuickTime и других стандартных плеерах
- **SC-004**: Ошибки API отображаются пользователю понятными сообщениями вместо технических деталей
