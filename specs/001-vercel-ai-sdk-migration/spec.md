# Feature Specification: Миграция на Vercel AI SDK

**Feature Branch**: `001-vercel-ai-sdk-migration`  
**Created**: 2026-01-09  
**Status**: Draft  
**Input**: User description: "Миграция с прямых вызовов Google API на Vercel AI SDK последней версии для генерации изображений и видео"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Генерация изображений через AI SDK (Priority: P1)

Как разработчик, я хочу чтобы все эндпоинты генерации изображений использовали единый унифицированный интерфейс Vercel AI SDK вместо прямых HTTP-вызовов к Google API, чтобы код был более поддерживаемым, типобезопасным и легко адаптируемым к другим провайдерам AI.

**Why this priority**: Генерация изображений — ключевая функциональность приложения, используемая в 3 из 4 API endpoints. Унификация этой части даёт наибольший эффект от миграции.

**Independent Test**: Можно полностью протестировать, загрузив фотографию продукта и выполнив операции "Product Enhance", "Angles" и базовую генерацию через стандартный интерфейс — результат должен быть идентичен текущему.

**Acceptance Scenarios**:

1. **Given** пользователь загружает изображение продукта, **When** выбирает стиль "Studio" и нажимает кнопку улучшения, **Then** система возвращает улучшенное изображение через AI SDK с качеством не хуже текущего
2. **Given** пользователь использует функцию "Angles", **When** меняет угол поворота на 45°, **Then** генерируется новое изображение с нужным ракурсом через AI SDK
3. **Given** система работает в demo-режиме (без API ключа), **When** пользователь запрашивает генерацию, **Then** возвращается placeholder без ошибок

---

### User Story 2 - Сохранение видеогенерации на текущем API (Priority: P2)

Как разработчик, я хочу чтобы эндпоинт генерации fashion-motion видео продолжал использовать `@google/genai` для Veo 3.1, так как Vercel AI SDK пока не имеет нативной поддержки видеогенерации.

**Why this priority**: Видеогенерация работает стабильно на текущей реализации. Миграция на AI SDK будет выполнена в будущем, когда появится нативная поддержка `generateVideo`.

**Independent Test**: Загрузить изображение модели в одежде, запустить генерацию видео через Fashion Motion и получить работающее видео (без изменений в поведении).

**Acceptance Scenarios**:

1. **Given** пользователь загружает фото модели в одежде, **When** нажимает кнопку генерации fashion-видео, **Then** система генерирует видео через существующий `@google/genai` интерфейс без изменений
2. **Given** генерация видео занимает больше 1 минуты, **When** система ожидает результат, **Then** пользователь видит индикатор прогресса без зависания

> **Решение**: Видеогенерация (`/api/fashion-motion`) остаётся на `@google/genai` до появления нативной поддержки в Vercel AI SDK.

---

### User Story 3 - Унификация провайдера и конфигурации (Priority: P3)

Как разработчик, я хочу иметь единый файл конфигурации AI-провайдера с централизованным управлением API-ключами и настройками моделей, чтобы легко переключаться между моделями и отслеживать использование.

**Why this priority**: Упрощает поддержку и расширение функциональности, но не влияет на текущий пользовательский опыт.

**Independent Test**: Изменить модель в одном месте конфигурации — все API endpoints должны использовать новую модель.

**Acceptance Scenarios**:

1. **Given** конфигурация AI-провайдера централизована, **When** меняется название модели в конфиге, **Then** все endpoints используют новую модель без изменения их кода

---

### Edge Cases

- Что происходит, если API-ключ отсутствует или невалиден? — Система переходит в demo-режим с placeholder'ами
- Как система обрабатывает rate-limiting от Google API? — Возвращает понятное сообщение об ошибке
- Что если модель недоступна (deprecation)? — Логируется предупреждение, fallback на альтернативную модель

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА использовать `@ai-sdk/google` пакет для всех операций генерации изображений
- **FR-002**: Система ДОЛЖНА использовать функцию `generateText` с `responseModalities: ['Image']` для моделей Gemini с поддержкой генерации изображений
- **FR-003**: Система ДОЛЖНА сохранить все текущие настройки (стили, платформы, промпты) при миграции
- **FR-004**: Система ДОЛЖНА поддерживать demo-режим без API-ключа
- **FR-005**: Система ДОЛЖНА обрабатывать ошибки AI SDK и преобразовывать их в понятные пользователю сообщения
- **FR-006**: Для видеогенерации система ДОЛЖНА продолжать использовать `@google/genai` до появления нативной поддержки в AI SDK
- **FR-007**: Система ДОЛЖНА иметь централизованную конфигурацию AI-провайдера

### Key Entities *(include if feature involves data)*

- **AIProvider**: Централизованная конфигурация провайдера Google AI с API-ключом и настройками
- **ImageGenerationRequest**: Запрос на генерацию изображения (prompt, style, aspectRatio, model)
- **ImageGenerationResponse**: Ответ с сгенерированным изображением (base64, mimeType)
- **VideoGenerationRequest**: Запрос на генерацию видео (imageData, mimeType, aspectRatio, duration)
- **VideoGenerationResponse**: Ответ с сгенерированным видео (videoData, mimeType)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Основные 3 API эндпоинта генерации изображений успешно мигрированы и проходят функциональное тестирование
- **SC-002**: Качество генерируемых изображений не ухудшилось по сравнению с текущей реализацией
- **SC-003**: Время ответа эндпоинтов не увеличилось более чем на 10% (baseline замеряется перед миграцией)
- **SC-004**: Кодовая база уменьшена минимум на 20% за счёт унификации (меньше дублирования логики fetch/parsing)
- **SC-005**: Все существующие стили и настройки продолжают работать без изменений в UI
- **SC-006**: Demo-режим функционирует корректно во всех endpoints

## Assumptions

- Vercel AI SDK `@ai-sdk/google` версии 4.0+ поддерживает необходимые модели Gemini
- API-ключ GEMINI_API_KEY совместим с AI SDK (использует тот же ключ)
- Текущие модели (`gemini-2.5-flash-image`, `gemini-3-pro-image-preview`) поддерживаются AI SDK
- Для видеогенерации Veo 3.1 может потребоваться сохранение прямых вызовов `@google/genai`, так как AI SDK пока не имеет нативной поддержки `generateVideo`
